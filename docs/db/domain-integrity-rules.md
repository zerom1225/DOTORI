# 도메인 무결성 규칙 문서 (1차 버전)

## 1. 이메일 인증 데이터는 임시 데이터이며 회원 정보와 강 결합하지 않는다
| 항목            | 내용                                                 |
| ------------- | -------------------------------------------------- |
| **도메인 규칙**    | 이메일 인증 데이터는 회원의 핵심 정보가 아니라 인증 과정에서만 사용하는 임시 데이터이다. |
| **필요한 이유**    | 트리거 기반 동기화는 유지보수와 디버깅이 어렵고 동시성 문제를 유발할 수 있다.       |
| **DB 적용 방식**  | MEMBER.email ↔ EMAIL_AUTH.email 트리거 제거 및 FK 의존성 제거 |
| **애플리케이션 처리** | 인증 성공 시 서비스 레이어에서 MEMBER.email을 트랜잭션으로 업데이트        |
| **테스트 케이스**   | 이메일 변경 시 MEMBER만 갱신되고 트리거가 실행되지 않는지 확인             |


## 2. 닉네임은 사용자 식별에 사용되므로 중복을 허용하지 않는다. 
| 항목            | 내용                                  |
| ------------- | ----------------------------------- |
| **도메인 규칙**    | 닉네임은 사용자 식별 요소로 활용되므로 중복을 허용하지 않는다. |
| **필요한 이유**    | 사용자 검색 및 채팅 표시에서 혼동을 방지하기 위함이다.     |
| **DB 적용 방식**  | MEMBER.nickname UNIQUE 제약 추가    ☑   |
| **애플리케이션 처리** | 회원가입 시 중복 검사 후 저장                   |
| **테스트 케이스**   | 동일 닉네임으로 회원가입 시 DB 오류 발생 확인         |

## 3. 회원 권한(role)은 정의된 값만 허용한다.
| 항목            | 내용                                   |
| ------------- | ------------------------------------ |
| **도메인 규칙**    | 회원 권한은 서비스에서 정의된 값만 허용한다.            |
| **필요한 이유**    | 잘못된 권한값 저장으로 인한 접근 제어 오류를 방지하기 위함이다. |
| **DB 적용 방식**  | MEMBER.role CHECK 제약 추가  ☑            |
| **애플리케이션 처리** | Enum으로 권한값 관리                        |
| **테스트 케이스**   | 허용되지 않은 role 저장 시 DB 오류 발생 확인        |

## 4. 회원 탈퇴는 물리삭제가 아닌 상태 변경으로 관리한다.
| 항목            | 내용                                           |
| ------------- | -------------------------------------------- |
| **도메인 규칙**    | 회원은 거래 및 채팅 기록 보존을 위해 물리삭제하지 않고 탈퇴 상태로 관리한다. |
| **필요한 이유**    | 분쟁 대응 및 감사 로그 유지가 필요하다.                      |
| **DB 적용 방식**  | MEMBER.status 컬럼 추가  ☑                         |
| **애플리케이션 처리** | 탈퇴 시 DELETE 대신 상태 업데이트 수행                    |
| **테스트 케이스**   | 탈퇴 후 거래/채팅 데이터 유지 확인                         |

## 5. 게시글 이미지는 저장 방식의 적합성을 검토한다 (선택)
| 항목            | 내용                                         |
| ------------- | ------------------------------------------ |
| **도메인 규칙**    | 이미지 데이터는 DB 저장보다 파일/URL 참조 방식이 더 적합할 수 있다. |
| **필요한 이유**    | DB 용량 증가 및 조회 성능 저하를 방지하기 위함이다.            |
| **DB 적용 방식**  | board_image CLOB 유지 또는 별도 테이블/URL 방식 검토    |
| **애플리케이션 처리** | 업로드 시 파일 저장 후 경로 저장                        |
| **테스트 케이스**   | 이미지 저장/조회 성능 비교 테스트                        |

## 6. 거래 방식(how_trade)은 정의된 값만 허용한다
| 항목            | 내용                                  |
| ------------- | ----------------------------------- |
| **도메인 규칙**    | 거래 방식은 서비스에서 정의된 값만 허용한다.           |
| **필요한 이유**    | 잘못된 값 저장으로 인한 검색/필터 오류 방지           |
| **DB 적용 방식**  | PRODUCT_BOARD.how_trade CHECK 제약 추가 ☑  |
| **애플리케이션 처리** | Enum 관리                             |
| **테스트 케이스**   | 허용되지 않은 값 저장 시 DB 오류 확인             |

## 7. 게시글 상태는 정의된 값만 허용하며 삭제는 상태로 관리한다
| 항목            | 내용                                     |
| ------------- | -------------------------------------- |
| **도메인 규칙**    | 게시글 삭제는 물리삭제가 아니라 상태값으로 관리한다.          |
| **필요한 이유**    | 거래/채팅 기록과의 정합성 유지                      |
| **DB 적용 방식**  | PRODUCT_BOARD.board_status CHECK 제약 추가 |
| **애플리케이션 처리** | 삭제 시 상태값 변경                            |
| **테스트 케이스**   | 삭제 후 게시글이 조회되지 않는지 확인                  |

## 8. 거래 기록은 회원 삭제로 인해 변경되지 않도록 한다
| 항목            | 내용                                         |
| ------------- | ------------------------------------------ |
| **도메인 규칙**    | 거래 기록은 감사 데이터이므로 참여자 정보가 NULL로 변하지 않도록 한다. |
| **필요한 이유**    | 거래 당사자 정보는 서비스 핵심 데이터이다.                   |
| **DB 적용 방식**  | TRANSACTION FK의 ON DELETE SET NULL 제거      |
| **애플리케이션 처리** | 회원 삭제 대신 soft delete 사용                    |
| **테스트 케이스**   | 회원 탈퇴 후 거래 정보 유지 확인                        |

## 9. 거래 기록은 게시글 삭제로 인해 삭제되지 않도록 한다
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 거래는 게시글보다 더 중요한 기록이므로 게시글 삭제로 제거되지 않는다. |
| **필요한 이유**    | 분쟁 대응 및 거래 이력 보존                        |
| **DB 적용 방식**  | TRANSACTION.board_id CASCADE 제거         |
| **애플리케이션 처리** | 게시글 삭제 시 상태 변경만 수행                      |
| **테스트 케이스**   | 게시글 삭제 후 거래 데이터 유지 확인                   |

## 10. 거래 상태는 정의된 값만 허용한다
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 거래 상태는 정의된 값만 허용한다. |
| **필요한 이유**    |  잘못된 값 저장으로 인한 검색/필터 오류 방지                        |
| **DB 적용 방식**  | TRANSACTION.transaction_status에 CHECK 제약 추가        |
| **애플리케이션 처리** | Enum 관리                      |
| **테스트 케이스**   | 허용되지 않은 값 저장 시 DB 오류 확인   |

## 11. 채팅 기록은 보존 대상이므로 회원 삭제로 참여자 정보가 NULL로 변하지 않도록 한다
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 채팅 기록은 감사 데이터이므로 참여자 정보가 NULL로 변하지 않도록 한다. |
| **필요한 이유**    |  채팅 참여자 정보는 서비스 핵심 데이터이다.                        |
| **DB 적용 방식**  | CHAT.seller_id/buyer_id의 ON DELETE SET NULL  제거      |
| **애플리케이션 처리** | 회원 삭제 대신 soft delete 사용                      |
| **테스트 케이스**   | 회원 탈퇴 후 채팅 정보 유지 확인   |

## 12. 채팅 기록은 게시글 삭제로 함께 삭제되지 않는다.
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 채팅 기록은 게시글 삭제로 제거되지 않는다. |
| **필요한 이유**    |  분쟁 대응 및 채팅 이력 보존                       |
| **DB 적용 방식**  | CHAT.board_id의 ON DELETE CASCADE 제거     |
| **애플리케이션 처리** | 게시글 삭제 시 상태 변경만 수행                      |
| **테스트 케이스**   | 게시글 삭제 후 채팅 데이터 유지 확인   |

## 13. 채팅 활성 상태(is_active)는 정의된 값만 허용한다.
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 채팅 활성 상태는 정의된 값만 허용한다. |
| **필요한 이유**    |  잘못된 값 저장으로 인한 검색/필터 오류 방지                       |
| **DB 적용 방식**  | CHAT.is_active에 CHECK 제약 추가   |
| **애플리케이션 처리** | Enum 관리                      |
| **테스트 케이스**   | 허용되지 않은 값 저장 시 DB 오류 확인   |

## 14. 메시지는 채팅방에 종속되며 채팅방은 물리 삭제하지 않는다.
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 메시지는 채팅방에 종속되며 채팅방은 물리 삭제하지 않는다. |
| **필요한 이유**    |  분쟁 대응 및 채팅 메시지 이력 보존                      |
| **DB 적용 방식**  | CHAT_MESSAGE.chat_id FK 유지 및 ON DELETE CASCADE 제거   |
| **애플리케이션 처리** | 채팅방 삭제 시 DELETE 대신 상태 업데이트 수행                      |
| **테스트 케이스**   | 채팅방 삭제 후 채팅 데이터 유지 확인   |

## 15. 메시지 발신자는 감사 목적상 NULL로 바꾸지 않는다.
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 메시지는 감사 데이터이므로 참여자 정보가 NULL로 변하지 않도록 한다. |
| **필요한 이유**    |  분쟁 대응 및 감사 로그 유지가 필요하다.                      |
| **DB 적용 방식**  | CHAT_MESSAGE.sender_id ON DELETE SET NULL 제거   |
| **애플리케이션 처리** | 회원 삭제 대신 soft delete 사용                     |
| **테스트 케이스**   | 회원 탈퇴 후 채팅 메시지 정보 유지 확인   |

## 16. 신고 데이터는 게시글 삭제로 함께 삭제되지 않도록 한다.
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 신고는 중요한 기록이므로 게시글 삭제로 제거되지 않는다. |
| **필요한 이유**    | 분쟁 대응 및 신고 이력 보존                        |
| **DB 적용 방식**  | BOARD_REPORT.board_id CASCADE 제거         |
| **애플리케이션 처리** | 게시글 삭제 시 상태 변경만 수행                      |
| **테스트 케이스**   | 게시글 삭제 후 신고 데이터 유지 확인                   |

## 17. 신고 대상 유저는 NULL로 변경하지 않는다.
| 항목            | 내용                                         |
| ------------- | ------------------------------------------ |
| **도메인 규칙**    | 신고 기록은 감사 데이터이므로 신고자 정보가 NULL로 변하지 않도록 한다. |
| **필요한 이유**    | 신고 대상 유저 정보는 서비스 핵심 데이터이다.                   |
| **DB 적용 방식**  | BOARD_REPORT.report_user_id 의 ON DELETE SET NULL 제거      |
| **애플리케이션 처리** | 회원 삭제 대신 soft delete 사용                    |
| **테스트 케이스**   | 회원 탈퇴 후 신고 대상 유저 정보 유지 확인                        |

## 18. 신고 카테고리는 정의된 값만 허용한다
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 신고 카테고리는 정의된 값만 허용한다. |
| **필요한 이유**    |  잘못된 값 저장으로 인한 검색/필터 오류 방지                        |
| **DB 적용 방식**  | BOARD_REPORT.report_category 에 CHECK 제약 추가        |
| **애플리케이션 처리** | Enum 관리                      |
| **테스트 케이스**   | 허용되지 않은 값 저장 시 DB 오류 확인   |

## 19. 신고 처리 상태는 정의된 값만 허용한다
| 항목            | 내용                                      |
| ------------- | --------------------------------------- |
| **도메인 규칙**    | 신고 처리 상태는 정의된 값만 허용한다. |
| **필요한 이유**    |  잘못된 값 저장으로 인한 검색/필터 오류 방지                        |
| **DB 적용 방식**  |  BOARD_REPORT.report_status에 CHECK 제약 추가        |
| **애플리케이션 처리** | Enum 관리                      |
| **테스트 케이스**   | 허용되지 않은 값 저장 시 DB 오류 확인   |


- (추가 1) hard delete 허용 조건

게시글 hard delete는 예외 조건에서만 허용한다. (예: 거래/채팅/신고가 없는 경우에만, 혹은 관리자 정책에 의해서만)

→ 이거 하나 넣으면 “삭제정책 설계”가 확 살아.

- (추가 2) FK는 기본적으로 NOT NULL + 인덱스

자식 테이블의 FK 컬럼은 원칙적으로 NOT NULL이며, FK 컬럼 인덱스를 둔다.
(오라클에서 FK 인덱스 없으면 잠금/성능 이슈 가능)

- (추가 3) 생성/수정 시간 컬럼 운영

모든 핵심 엔티티는 created_at/updated_at을 가진다. (정렬/감사/장애 분석)

- (추가 4) 이메일은 회원의 고유 값 정책

이메일이 로그인 키면: MEMBER.email UNIQUE + NOT NULL이 기본.

이메일 변경은 인증 후 1회 트랜잭션으로 처리(1번과 연결)

- (추가 5) 상태값을 숫자로 둘 때 “매핑 표”를 문서에 포함

role/status/how_trade/transaction_status/report_status 등은

값 의미표(0=..., 1=...)를 DB 설계 문서에 박아 넣기